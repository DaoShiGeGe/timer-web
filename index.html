<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高级在线计时器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            accent: '#FF7D00',
            exam: '#722ED1',
            dark: '#1D2129',
            light: '#F2F3F5',
            danger: '#F53F3F'
          },
          fontFamily: {
            digital: ['SimHei', '黑体', 'monospace'],
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .btn-hover {
        @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5 active:translate-y-0;
      }
      .btn-animation {
        @apply transition-all duration-300 transform hover:scale-105 active:scale-95;
      }
      .ms-display {
        @apply text-[clamp(1rem,3vw,1.5rem)] text-gray-500 ml-2 align-text-top font-digital min-w-[30px] text-right;
      }
      .time-display-container {
        @apply font-bold text-[clamp(2.5rem,8vw,4.5rem)] text-shadow font-digital min-w-[220px] text-center;
      }
      .time-over {
        @apply text-danger;
      }
      .mode-active {
        @apply bg-white/20 text-white;
      }
      .mode-inactive {
        @apply bg-white/10 text-white/80;
      }
    }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-light to-white min-h-screen p-4 text-dark flex flex-col items-center">
  <div class="max-w-3xl w-full bg-white rounded-2xl shadow-xl overflow-hidden">
    <!-- 标题和模式切换 -->
    <div class="bg-primary text-white p-4">
      <h1 class="text-[clamp(1.3rem,3vw,1.6rem)] font-bold text-center">高级计时器</h1>
      
      <div class="flex justify-center mt-2 gap-2 flex-wrap">
        <button id="stopwatch-mode" class="px-3 py-1.5 rounded-full mode-inactive font-medium btn-hover text-sm">
          <i class="fa fa-clock-o mr-1"></i>正计时
        </button>
        <button id="timer-mode" class="px-3 py-1.5 rounded-full mode-inactive font-medium btn-hover text-sm">
          <i class="fa fa-hourglass-start mr-1"></i>倒计时
        </button>
        <button id="exam-mode" class="px-3 py-1.5 rounded-full mode-active font-medium btn-hover text-sm">
          <i class="fa fa-pencil mr-1"></i>考试计时
        </button>
      </div>
    </div>
    
    <!-- 时间显示区域 -->
    <div class="p-4 flex flex-col items-center">
      <!-- 核心：数字显示 -->
      <div class="flex items-center mb-3">
        <span id="time-display" class="time-display-container">00:00:00</span>
        <span id="ms-display" class="ms-display">00</span>
      </div>
      
      <!-- 中间功能区：设置 + 控制按钮 -->
      <div class="w-full flex flex-col md:flex-row gap-4 mb-3">
        <!-- 左侧：设置区域 -->
        <div class="flex-1 relative">
          <!-- 倒计时设置区域 -->
          <div id="timer-setting" class="hidden">
            <div class="flex justify-center gap-2 flex-wrap">
              <div class="text-center">
                <label for="hours" class="block text-xs text-gray-500 mb-0.5">小时</label>
                <input type="number" id="hours" min="0" max="23" value="0" 
                      class="w-12 p-1 border border-gray-300 rounded-lg text-center text-sm font-digital focus:outline-none focus:ring-2 focus:ring-primary/50">
              </div>
              <div class="text-center">
                <label for="minutes" class="block text-xs text-gray-500 mb-0.5">分钟</label>
                <input type="number" id="minutes" min="0" max="59" value="0" 
                      class="w-12 p-1 border border-gray-300 rounded-lg text-center text-sm font-digital focus:outline-none focus:ring-2 focus:ring-primary/50">
              </div>
              <div class="text-center">
                <label for="seconds" class="block text-xs text-gray-500 mb-0.5">秒钟</label>
                <input type="number" id="seconds" min="0" max="59" value="10" 
                      class="w-12 p-1 border border-gray-300 rounded-lg text-center text-sm font-digital focus:outline-none focus:ring-2 focus:ring-primary/50">
              </div>
            </div>
          </div>
          
          <!-- 考试计时设置区域 -->
          <div id="exam-setting" class="">
            <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
              <div class="flex flex-col gap-1.5 -mt-3">
                <button id="exam-2h" class="px-2.5 py-1 bg-exam/10 text-exam rounded-lg btn-hover text-xs">2小时</button>
                <button id="exam-2h30m" class="px-2.5 py-1 bg-exam/10 text-exam rounded-lg btn-hover text-xs">2小时30分</button>
              </div>
              
              <div class="flex gap-2">
                <div class="text-center">
                  <label for="exam-hours" class="block text-xs text-gray-500 mb-0.5">小时</label>
                  <input type="number" id="exam-hours" min="0" max="23" value="2" 
                        class="w-12 p-1 border border-gray-300 rounded-lg text-center text-sm font-digital focus:outline-none focus:ring-2 focus:ring-exam/50">
                </div>
                <div class="text-center">
                  <label for="exam-minutes" class="block text-xs text-gray-500 mb-0.5">分钟</label>
                  <input type="number" id="exam-minutes" min="0" max="59" value="0" 
                        class="w-12 p-1 border border-gray-300 rounded-lg text-center text-sm font-digital focus:outline-none focus:ring-2 focus:ring-exam/50">
                </div>
                <div class="text-center">
                  <label for="exam-seconds" class="block text-xs text-gray-500 mb-0.5">秒钟</label>
                  <input type="number" id="exam-seconds" min="0" max="59" value="0" 
                        class="w-12 p-1 border border-gray-300 rounded-lg text-center text-sm font-digital focus:outline-none focus:ring-2 focus:ring-exam/50">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 右侧：控制按钮 - 修改了顺序和样式 -->
        <div class="flex justify-center items-center">
          <div class="flex gap-2">
            <!-- 分次计时按钮 -->
            <button id="lap-btn" class="w-12 h-12 rounded-full bg-accent text-white flex items-center justify-center btn-animation hover:bg-accent/90 shadow-md hover:shadow-lg">
              <i class="fa fa-flag"></i>
            </button>
            
            <!-- 开始/暂停按钮 -->
            <button id="start-btn" class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center btn-animation hover:bg-primary/90 shadow-md hover:shadow-lg">
              <i class="fa fa-play"></i>
            </button>
            <button id="pause-btn" class="w-12 h-12 rounded-full bg-gray-200 text-gray-700 flex items-center justify-center btn-animation hover:bg-gray-300 shadow-md hover:shadow-lg hidden">
              <i class="fa fa-pause"></i>
            </button>
            
            <!-- 重置按钮 - 修改为红色 -->
            <button id="reset-btn" class="w-12 h-12 rounded-full bg-danger text-white flex items-center justify-center btn-animation hover:bg-red-600 shadow-md hover:shadow-lg">
              <i class="fa fa-refresh"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- 计时记录区域 -->
      <div class="w-full max-h-[320px] overflow-y-auto border-t border-gray-100 pt-2">
        <div class="text-center text-gray-500 text-xs mb-1">计时记录</div>
        <ul id="laps-list" class="space-y-1 text-sm font-digital">
          <!-- 这里将使用倒序展示，最新的记录在最上面 -->
        </ul>
      </div>
    </div>
  </div>
  
  <footer class="mt-4 text-center text-gray-500 text-xs">
    <p>高级在线计时器 &copy; 2023</p>
  </footer>

  <script>
    // 状态变量 - 各模式独立运行，互不干扰
    const state = {
      currentMode: 'exam', // 当前显示的模式
      modes: {
        stopwatch: {
          running: false,
          startTime: null,
          elapsedTime: 0,
          laps: [],
          currentLapStart: 0, // 当前分段的开始时间
          currentLapIndex: 0  // 当前分段序号
        },
        timer: {
          running: false,
          startTime: null,
          elapsedTime: 0,
          targetTime: 10 * 1000, // 目标倒计时时间，默认10秒
          laps: [],
          lastAlertTime: -1,
          currentLapStart: 0, // 当前分段的开始时间
          currentLapIndex: 0,  // 当前分段序号
          isOverTime: false, // 是否已超时
          overTimeStart: 0 // 超时开始时间
        },
        exam: {
          running: false,
          startTime: null,
          elapsedTime: 0,
          duration: 2 * 60 * 60 * 1000, // 考试总时长（毫秒）
          laps: [],
          hasTriggered15min: false, // 剩余15分钟提醒标记
          hasTriggeredEnd: false, // 结束提醒标记
          overTimeStart: 0, // 超时开始时间（毫秒）
          lastOverTimeLap: 0, // 上次超时分段的时间点
          currentLapStart: 0, // 当前分段的开始时间
          currentLapIndex: 0,  // 当前分段序号
          overtimeLaps: [], // 超时后的分段记录
          overtimeLapCount: 0 // 超时分段计数器
        }
      },
      globalInterval: null, // 全局计时器（统一更新所有运行中的模式）
      audioContext: null,
      alertPlaying: false
    };
    
    // DOM元素
    const elements = {
      timeDisplay: document.getElementById('time-display'),
      msDisplay: document.getElementById('ms-display'),
      startBtn: document.getElementById('start-btn'),
      pauseBtn: document.getElementById('pause-btn'),
      resetBtn: document.getElementById('reset-btn'),
      lapBtn: document.getElementById('lap-btn'),
      stopwatchModeBtn: document.getElementById('stopwatch-mode'),
      timerModeBtn: document.getElementById('timer-mode'),
      examModeBtn: document.getElementById('exam-mode'),
      timerSetting: document.getElementById('timer-setting'),
      examSetting: document.getElementById('exam-setting'),
      hoursInput: document.getElementById('hours'),
      minutesInput: document.getElementById('minutes'),
      secondsInput: document.getElementById('seconds'),
      examHoursInput: document.getElementById('exam-hours'),
      examMinutesInput: document.getElementById('exam-minutes'),
      examSecondsInput: document.getElementById('exam-seconds'),
      exam2hBtn: document.getElementById('exam-2h'),
      exam2h30mBtn: document.getElementById('exam-2h30m'),
      lapsList: document.getElementById('laps-list')
    };
    
    // 初始化音频上下文
    function initAudioContext() {
      if (!state.audioContext) {
        try {
          state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          // 立即恢复上下文，确保可以播放声音
          if (state.audioContext.state === 'suspended') {
            state.audioContext.resume();
          }
        } catch (e) {
          console.error('无法初始化音频上下文:', e);
          // 降级方案：使用HTML5 Audio
          return null;
        }
      } else if (state.audioContext.state === 'suspended') {
        state.audioContext.resume();
      }
      return state.audioContext;
    }
    
    // 创建音频缓冲区
    function createBeepBuffer(audioContext, duration, frequency, volume) {
      const sampleRate = audioContext.sampleRate;
      const numSamples = Math.floor(duration * sampleRate);
      const buffer = audioContext.createBuffer(1, numSamples, sampleRate);
      const data = buffer.getChannelData(0);
      
      for (let i = 0; i < numSamples; i++) {
        data[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * volume;
      }
      
      return buffer;
    }
    
    // 播放提醒声音
    function playAlertSound(interval = 500) {
      if (state.alertPlaying) return;
      
      // 先尝试恢复音频上下文
      const audioCtx = initAudioContext();
      
      // 如果Web Audio API不可用，尝试使用HTML5 Audio作为降级方案
      if (!audioCtx) {
        try {
          // 创建一个简单的beep声音
          const beep = () => {
            const oscillator = new (window.AudioContext || window.webkitAudioContext)().createOscillator();
            const gainNode = oscillator.context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(oscillator.context.destination);
            
            oscillator.frequency.value = 800;
            gainNode.gain.value = 0.1;
            
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.001, oscillator.context.currentTime + 0.2);
            oscillator.stop(oscillator.context.currentTime + 0.2);
          };
          
          state.alertPlaying = true;
          
          // 播放5次beep，每次间隔interval毫秒
          let count = 0;
          const maxCount = 5;
          
          const playInterval = setInterval(() => {
            if (count >= maxCount) {
              clearInterval(playInterval);
              state.alertPlaying = false;
              return;
            }
            
            beep();
            count++;
          }, interval);
          
        } catch (e) {
          console.log('无法播放提醒声音');
        }
        return;
      }
      
      state.alertPlaying = true;
      
      // 创建beep缓冲区
      const beepBuffer = createBeepBuffer(audioCtx, 0.2, 800, 0.1);
      
      // 总时长5秒
      const totalDuration = 5000;
      const beepCount = Math.floor(totalDuration / interval);
      let currentBeep = 0;
      
      const beepInterval = setInterval(() => {
        if (currentBeep >= beepCount) {
          clearInterval(beepInterval);
          state.alertPlaying = false;
          return;
        }
        
        // 播放beep
        const source = audioCtx.createBufferSource();
        source.buffer = beepBuffer;
        source.connect(audioCtx.destination);
        source.start();
        
        currentBeep++;
      }, interval);
      
      // 安全超时
      setTimeout(() => {
        clearInterval(beepInterval);
        state.alertPlaying = false;
      }, totalDuration + 100);
    }
    
    // 格式化时间 (毫秒 -> HH:MM:SS)
    function formatTime(ms) {
      // 确保时间不为负数
      if (ms < 0) {
        ms = 0;
      }
      
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      return [
        hours.toString().padStart(2, '0'),
        minutes.toString().padStart(2, '0'),
        seconds.toString().padStart(2, '0')
      ].join(':');
    }
    
    // 格式化毫秒
    function formatMilliseconds(ms) {
      // 确保时间不为负数
      if (ms < 0) {
        ms = 0;
      }
      
      const milliseconds = Math.floor((ms % 1000) / 10);
      return milliseconds.toString().padStart(2, '0');
    }
    
    // 全局计时器更新函数（更新所有运行中的模式）
    function updateAllRunningModes() {
      const now = Date.now();
      
      // 更新所有运行中的模式
      Object.values(state.modes).forEach(mode => {
        if (mode.running && mode.startTime) {
          mode.elapsedTime = now - mode.startTime;
        }
      });
      
      // 更新当前显示模式的时间
      updateTimeDisplay();
      
      // 更新当前分段的时间
      updateCurrentLapTime();
      
      // 如果是考试超时状态，实时更新超时分段的时间
      if (state.currentMode === 'exam' && state.modes.exam.hasTriggeredEnd) {
        updateOverTimeLap();
      }
    }
    
    // 更新当前分段的时间
    function updateCurrentLapTime() {
      const mode = state.modes[state.currentMode];
      if (!mode.running || mode.currentLapIndex === 0) return;
      
      // 找到当前分段
      const currentLap = mode.laps.find(lap => lap.isCurrent);
      if (currentLap) {
        currentLap.duration = mode.elapsedTime - mode.currentLapStart;
        currentLap.total = mode.elapsedTime;
      }
      
      updateLapsList();
    }
    
    // 更新当前模式的时间显示
    function updateTimeDisplay() {
      const mode = state.modes[state.currentMode];
      let mainTime, ms;
      
      // 首先移除红色警告样式
      elements.timeDisplay.classList.remove('time-over');
      elements.msDisplay.classList.remove('time-over');
      
      switch (state.currentMode) {
        case 'stopwatch':
          mainTime = formatTime(mode.elapsedTime);
          ms = formatMilliseconds(mode.elapsedTime);
          break;
          
        case 'timer':
          // 修复：确保剩余时间不为负数
          const remainingTime = Math.max(0, mode.targetTime - mode.elapsedTime);
          
          // 检查是否已超时
          if (mode.running && mode.elapsedTime >= mode.targetTime && !mode.isOverTime) {
            mode.isOverTime = true;
            mode.overTimeStart = mode.elapsedTime;
            playAlertSound();
          }
          
          // 如果已超时，显示正计时时间并变红
          if (mode.isOverTime) {
            const overTime = mode.elapsedTime - mode.targetTime;
            mainTime = formatTime(overTime);
            ms = formatMilliseconds(overTime);
            elements.timeDisplay.classList.add('time-over');
            elements.msDisplay.classList.add('time-over');
          } else {
            mainTime = formatTime(remainingTime);
            ms = formatMilliseconds(remainingTime);
            
            // 修复：初始状态下颜色为默认颜色
            // 只有当正在运行且剩余时间为0时才变红
            if (mode.running && remainingTime === 0) {
              elements.timeDisplay.classList.add('time-over');
              elements.msDisplay.classList.add('time-over');
            }
          }
          
          // 倒计时结束提醒
          if (mode.running && remainingTime === 0 && mode.lastAlertTime !== 0) {
            playAlertSound();
            mode.lastAlertTime = 0;
          }
          break;
          
        case 'exam':
          // 考试计时采用正计时（显示已用时间）
          mainTime = formatTime(mode.elapsedTime);
          ms = formatMilliseconds(mode.elapsedTime);
          
          // 剩余时间计算
          const remainingTimeExam = mode.duration - mode.elapsedTime;
          
          // 记录超时开始时间
          if (mode.running && mode.elapsedTime >= mode.duration && !mode.hasTriggeredEnd) {
            state.modes.exam.overTimeStart = mode.elapsedTime;
            state.modes.exam.lastOverTimeLap = mode.elapsedTime;
          }
          
          // 考试剩余15分钟提醒（仅当总时长≥15分钟时触发）
          if (mode.running && 
              mode.duration >= 15 * 60 * 1000 && // 总时长≥15分钟
              remainingTimeExam <= 15 * 60 * 1000 && 
              remainingTimeExam > 0 && 
              !mode.hasTriggered15min) {
            playAlertSound(1000); // 每秒一次
            mode.hasTriggered15min = true;
          }
          
          // 考试结束提醒
          if (mode.running && mode.elapsedTime >= mode.duration && !mode.hasTriggeredEnd) {
            elements.timeDisplay.classList.add('time-over');
            elements.msDisplay.classList.add('time-over');
            
            // 创建考试结束分段
            createExamEndLaps();
            
            playAlertSound(); // 每0.5秒一次
            mode.hasTriggeredEnd = true;
          }
          
          // 修复：超时后始终显示红色
          if (mode.elapsedTime >= mode.duration) {
            elements.timeDisplay.classList.add('time-over');
            elements.msDisplay.classList.add('time-over');
          }
          break;
      }
      
      elements.timeDisplay.textContent = mainTime;
      elements.msDisplay.textContent = ms;
    }
    
    // 创建考试结束时的分段
    function createExamEndLaps() {
      const mode = state.modes.exam;
      const endTime = mode.elapsedTime;
      
      // 如果有当前分段，先结束它
      if (mode.currentLapIndex > 0) {
        const currentLap = mode.laps.find(lap => lap.isCurrent);
        if (currentLap) {
          currentLap.duration = endTime - mode.currentLapStart;
          currentLap.total = endTime;
          currentLap.isCurrent = false;
          currentLap.isDynamic = false;
        }
      }
      
      // 计算当前段数
      const segmentNumber = mode.laps.filter(lap => !lap.isCurrent).length + 1;
      
      // 增加超时分段计数器
      mode.overtimeLapCount++;
      
      // 创建超时段的记录（从0开始计时）
      mode.laps.push({
        index: segmentNumber,
        duration: 0, // 初始为0
        total: endTime,
        typeText: mode.overtimeLapCount === 1 ? "超时" : `超时${mode.overtimeLapCount}`,
        isOverTime: true,
        isDynamic: true, // 标记为动态更新的超时记录
        isCurrent: false,
        startTime: endTime // 记录超时开始时间
      });
      
      // 初始化超时后的分段记录
      mode.overtimeLaps = [{
        index: 1,
        duration: 0,
        overtimeTotal: 0, // 超时后的累计时间
        typeText: mode.overtimeLapCount === 1 ? "超时" : `超时${mode.overtimeLapCount}`,
        isOverTime: true,
        isDynamic: true,
        isCurrent: false,
        startTime: endTime
      }];
      
      // 更新当前分段信息
      mode.currentLapIndex = segmentNumber;
      mode.currentLapStart = endTime;
      
      updateLapsList();
    }
    
    // 更新超时分段的时间（实时更新）
    function updateOverTimeLap() {
      const mode = state.modes.exam;
      if (!mode.running || !mode.hasTriggeredEnd) return;
      
      // 更新超时后的累计时间
      if (mode.overtimeLaps.length > 0) {
        const lastOvertimeLap = mode.overtimeLaps[mode.overtimeLaps.length - 1];
        lastOvertimeLap.duration = mode.elapsedTime - lastOvertimeLap.startTime;
        lastOvertimeLap.overtimeTotal = mode.elapsedTime - mode.duration;
      }
      
      // 找到最后一个超时分段
      const overTimeLap = [...mode.laps].reverse().find(lap => lap.isDynamic && lap.isOverTime && !lap.isCurrent);
      if (!overTimeLap) return;
      
      // 更新超时持续时间
      overTimeLap.duration = mode.elapsedTime - overTimeLap.startTime;
      overTimeLap.total = mode.elapsedTime;
      
      updateLapsList();
    }
    
    // 开始当前模式计时
    function startTimer() {
      const mode = state.modes[state.currentMode];
      if (mode.running) return;
      
      // 初始化音频上下文
      initAudioContext();
      
      // 倒计时模式检查目标时间
      if (state.currentMode === 'timer' && mode.targetTime === 0) {
        if (!setTargetTime()) {
          alert('请设置有效的倒计时时间');
          return;
        }
      }
      
      // 如果还没有分段，自动创建第一个分段（适用于所有模式）
      if (mode.currentLapIndex === 0) {
        mode.currentLapIndex = 1;
        mode.currentLapStart = 0;
        
        // 创建第一个分段
        mode.laps.push({
          index: 1,
          duration: 0,
          total: 0,
          typeText: "第 1 段",
          isOverTime: false,
          isDynamic: true,
          isCurrent: true
        });
      }
      
      // 设置开始时间
      mode.startTime = Date.now() - mode.elapsedTime;
      mode.running = true;
      
      // 启动全局计时器（如果未启动）
      if (!state.globalInterval) {
        state.globalInterval = setInterval(updateAllRunningModes, 10);
      }
      
      // 更新按钮状态
      elements.startBtn.classList.add('hidden');
      elements.pauseBtn.classList.remove('hidden');
      
      // 更新分段列表显示
      updateLapsList();
    }
    
    // 暂停当前模式计时
    function pauseTimer() {
      const mode = state.modes[state.currentMode];
      if (!mode.running) return;
      
      mode.running = false;
      
      // 更新按钮状态
      elements.pauseBtn.classList.add('hidden');
      elements.startBtn.classList.remove('hidden');
      
      // 检查是否所有模式都已暂停，如果是则停止全局计时器
      const allPaused = Object.values(state.modes).every(m => !m.running);
      if (allPaused && state.globalInterval) {
        clearInterval(state.globalInterval);
        state.globalInterval = null;
      }
    }
    
    // 重置当前模式计时
    function resetTimer() {
      const mode = state.modes[state.currentMode];
      const wasRunning = mode.running;
      
      // 暂停当前模式
      if (wasRunning) {
        pauseTimer();
      }
      
      // 重置状态
      mode.elapsedTime = 0;
      mode.startTime = null;
      mode.laps = [];
      mode.currentLapStart = 0;
      mode.currentLapIndex = 0;
      
      // 模式特定重置
      if (state.currentMode === 'stopwatch') {
        // 正计时模式完全重置
      } else if (state.currentMode === 'timer') {
        // 倒计时模式：不重置目标时间，只重置其他状态
        mode.lastAlertTime = -1;
        mode.isOverTime = false;
        mode.overTimeStart = 0;
      } else if (state.currentMode === 'exam') {
        // 考试计时模式：不重置目标时间，只重置其他状态
        mode.hasTriggered15min = false;
        mode.hasTriggeredEnd = false;
        mode.overTimeStart = 0;
        mode.lastOverTimeLap = 0;
        mode.overtimeLaps = [];
        mode.overtimeLapCount = 0;
      }
      
      // 更新显示 - 确保重置后颜色恢复正常
      updateTimeDisplay();
      updateLapsList();
    }
    
    // 记录分次计时（适用于所有模式）
    function recordLap() {
      const mode = state.modes[state.currentMode];
      if (!mode.running) return;
      
      const now = mode.elapsedTime;
      
      // 如果有当前分段，先结束它
      if (mode.currentLapIndex > 0) {
        const currentLap = mode.laps.find(lap => lap.isCurrent);
        if (currentLap) {
          currentLap.duration = now - mode.currentLapStart;
          currentLap.total = now;
          currentLap.isCurrent = false;
          currentLap.isDynamic = false;
        }
      }
      
      // 开始新分段
      mode.currentLapIndex++;
      mode.currentLapStart = now;
      
      // 创建新分段的显示（持续时间为0）
      let typeText = `第 ${mode.currentLapIndex} 段`;
      
      // 倒计时模式超时处理
      if (state.currentMode === 'timer' && mode.isOverTime) {
        typeText = `超时${mode.currentLapIndex}`;
      }
      
      // 考试模式特殊处理
      if (state.currentMode === 'exam') {
        const isOverTime = now >= mode.duration;
        if (isOverTime && mode.hasTriggeredEnd) {
          mode.overtimeLapCount++;
          typeText = mode.overtimeLapCount === 1 ? "超时" : `超时${mode.overtimeLapCount}`;
          
          // 记录超时后的分段
          mode.overtimeLaps.push({
            index: mode.overtimeLapCount,
            duration: 0,
            overtimeTotal: now - mode.duration,
            typeText: typeText,
            isOverTime: true,
            isDynamic: true,
            isCurrent: false,
            startTime: now
          });
        }
      }
      
      mode.laps.push({
        index: mode.currentLapIndex,
        duration: 0,
        total: now,
        typeText: typeText,
        isOverTime: (state.currentMode === 'timer' && mode.isOverTime) || 
                   (state.currentMode === 'exam' && now >= mode.duration),
        isDynamic: true,
        isCurrent: true,
        startTime: now
      });
      
      updateLapsList();
    }
    
    // 更新分次计时列表（倒序展示，最新的记录在最上面）
    function updateLapsList() {
      const mode = state.modes[state.currentMode];
      elements.lapsList.innerHTML = '';
      
      if (mode.laps.length === 0) {
        elements.lapsList.innerHTML = '<li class="text-center text-gray-400 text-xs py-2">暂无记录</li>';
        return;
      }
      
      // 创建所有记录的副本并倒序排列（最新的在最上面）
      const allLaps = [...mode.laps];
      const reversedLaps = allLaps.reverse();
      
      // 显示所有分段记录（倒序显示，最新的记录在最上面）
      reversedLaps.forEach(lap => {
        const li = document.createElement('li');
        
        // 根据分段状态设置样式
        let textColorClass = '';
        if (lap.isCurrent) {
          textColorClass = 'text-blue-500'; // 当前分段用蓝色显示
        } else if (lap.isOverTime) {
          textColorClass = 'text-danger'; // 超时分段用红色显示
        }
        
        li.className = `flex justify-between items-center p-1.5 border-b border-gray-100 last:border-0 ${textColorClass}`;
        
        // 格式化时间显示，弱化毫秒部分
        const durationStr = formatTime(lap.duration);
        const durationMs = formatMilliseconds(lap.duration);
        
        // 对于考试模式超时后的分段，显示超时后的累计时间
        let totalStr, totalMs;
        if (state.currentMode === 'exam' && lap.isOverTime && mode.overtimeLaps.length > 0) {
          // 找到对应的超时后分段记录
          const overtimeLap = mode.overtimeLaps.find(ol => ol.startTime === lap.startTime);
          if (overtimeLap) {
            totalStr = formatTime(overtimeLap.overtimeTotal);
            totalMs = formatMilliseconds(overtimeLap.overtimeTotal);
          } else {
            totalStr = formatTime(lap.total - mode.duration);
            totalMs = formatMilliseconds(lap.total - mode.duration);
          }
        } else if (state.currentMode === 'timer' && lap.isOverTime) {
          // 倒计时模式超时后显示超时时间
          totalStr = formatTime(lap.total - mode.targetTime);
          totalMs = formatMilliseconds(lap.total - mode.targetTime);
        } else {
          totalStr = formatTime(lap.total);
          totalMs = formatMilliseconds(lap.total);
        }
        
        li.innerHTML = `
          <span class="text-xs ${textColorClass} w-16 text-left">${lap.typeText}</span>
          <span class="text-sm ${textColorClass}">
            ${durationStr}<span class="text-xs text-gray-400 ml-0.5">.${durationMs}</span>
          </span>
          <span class="text-sm ${textColorClass}">
            ${totalStr}<span class="text-xs text-gray-400 ml-0.5">.${totalMs}</span>
          </span>
        `;
        elements.lapsList.appendChild(li);
      });
      
      // 滚动到顶部，显示最新的记录
      elements.lapsList.scrollTop = 0;
    }
    
    // 设置倒计时目标时间
    function setTargetTime() {
      const mode = state.modes.timer;
      const hours = parseInt(elements.hoursInput.value) || 0;
      const minutes = parseInt(elements.minutesInput.value) || 0;
      const seconds = parseInt(elements.secondsInput.value) || 0;
      
      mode.targetTime = (hours * 3600 + minutes * 60 + seconds) * 1000;
      
      // 修复：设置目标时间后立即更新显示
      if (state.currentMode === 'timer' && !mode.running) {
        mode.elapsedTime = 0; // 重置已用时间
        updateTimeDisplay(); // 更新显示
      }
      
      return mode.targetTime > 0;
    }
    
    // 设置考试时长
    function setExamDuration(hours, minutes, seconds) {
      const mode = state.modes.exam;
      mode.duration = (hours * 3600 + minutes * 60 + seconds) * 1000;
      elements.examHoursInput.value = hours;
      elements.examMinutesInput.value = minutes;
      elements.examSecondsInput.value = seconds;
    }
    
    // 切换模式（保持计时连续性）
    function switchMode(newMode) {
      if (state.currentMode === newMode) return;
      
      state.currentMode = newMode;
      
      // 更新UI显示
      elements.stopwatchModeBtn.classList.remove('mode-active', 'mode-inactive');
      elements.timerModeBtn.classList.remove('mode-active', 'mode-inactive');
      elements.examModeBtn.classList.remove('mode-active', 'mode-inactive');
      
      elements.timerSetting.classList.add('hidden');
      elements.examSetting.classList.add('hidden');
      
      // 激活新模式UI
      const newModeState = state.modes[newMode];
      switch(newMode) {
        case 'stopwatch':
          elements.stopwatchModeBtn.classList.add('mode-active');
          elements.timerModeBtn.classList.add('mode-inactive');
          elements.examModeBtn.classList.add('mode-inactive');
          break;
        case 'timer':
          elements.stopwatchModeBtn.classList.add('mode-inactive');
          elements.timerModeBtn.classList.add('mode-active');
          elements.examModeBtn.classList.add('mode-inactive');
          elements.timerSetting.classList.remove('hidden');
          // 恢复倒计时输入框值
          const hours = Math.floor(newModeState.targetTime / (3600 * 1000)) || 0;
          const minutes = Math.floor((newModeState.targetTime % (3600 * 1000)) / (60 * 1000)) || 0;
          const seconds = Math.floor((newModeState.targetTime % (60 * 1000)) / 1000) || 0;
          elements.hoursInput.value = hours;
          elements.minutesInput.value = minutes;
          elements.secondsInput.value = seconds;
          break;
        case 'exam':
          elements.stopwatchModeBtn.classList.add('mode-inactive');
          elements.timerModeBtn.classList.add('mode-inactive');
          elements.examModeBtn.classList.add('mode-active');
          elements.examSetting.classList.remove('hidden');
          // 恢复考试时长输入框值
          const examHours = Math.floor(newModeState.duration / (3600 * 1000)) || 0;
          const examMinutes = Math.floor((newModeState.duration % (3600 * 1000)) / (60 * 1000)) || 0;
          const examSeconds = Math.floor((newModeState.duration % (60 * 1000)) / 1000) || 0;
          elements.examHoursInput.value = examHours;
          elements.examMinutesInput.value = examMinutes;
          elements.examSecondsInput.value = examSeconds;
          break;
      }
      
      // 更新控制按钮状态
      if (newModeState.running) {
        elements.startBtn.classList.add('hidden');
        elements.pauseBtn.classList.remove('hidden');
      } else {
        elements.pauseBtn.classList.add('hidden');
        elements.startBtn.classList.remove('hidden');
      }
      
      // 更新时间显示和记录列表
      updateTimeDisplay();
      updateLapsList();
    }
    
    // 事件监听
    elements.startBtn.addEventListener('click', startTimer);
    elements.pauseBtn.addEventListener('click', pauseTimer);
    elements.resetBtn.addEventListener('click', resetTimer);
    elements.lapBtn.addEventListener('click', recordLap);
    
    elements.stopwatchModeBtn.addEventListener('click', () => switchMode('stopwatch'));
    elements.timerModeBtn.addEventListener('click', () => switchMode('timer'));
    elements.examModeBtn.addEventListener('click', () => switchMode('exam'));
    
    elements.exam2hBtn.addEventListener('click', () => {
      if (state.currentMode === 'exam') {
        setExamDuration(2, 0, 0);
      }
    });
    
    elements.exam2h30mBtn.addEventListener('click', () => {
      if (state.currentMode === 'exam') {
        setExamDuration(2, 30, 0);
      }
    });
    
    function updateExamDurationOnInput() {
      if (state.currentMode === 'exam' && !state.modes.exam.running) {
        const hours = parseInt(elements.examHoursInput.value) || 0;
        const minutes = parseInt(elements.examMinutesInput.value) || 0;
        const seconds = parseInt(elements.examSecondsInput.value) || 0;
        setExamDuration(hours, minutes, seconds);
      }
    }
    
    elements.examHoursInput.addEventListener('input', updateExamDurationOnInput);
    elements.examMinutesInput.addEventListener('input', updateExamDurationOnInput);
    elements.examSecondsInput.addEventListener('input', updateExamDurationOnInput);
    
    // 修复：倒计时模式下修改目标时间时立即更新显示
    function updateTimerOnInput() {
      if (state.currentMode === 'timer' && !state.modes.timer.running) {
        setTargetTime();
      }
    }
    
    elements.hoursInput.addEventListener('input', updateTimerOnInput);
    elements.minutesInput.addEventListener('input', updateTimerOnInput);
    elements.secondsInput.addEventListener('input', updateTimerOnInput);
    
    // 添加输入验证和限制
    function validateInput(input, min, max) {
      let value = parseInt(input.value) || min;
      if (value < min) value = min;
      if (value > max) value = max;
      input.value = value;
    }
    
    // 为所有输入框添加验证
    [elements.hoursInput, elements.minutesInput, elements.secondsInput, 
     elements.examHoursInput, elements.examMinutesInput, elements.examSecondsInput].forEach(input => {
      input.addEventListener('blur', () => {
        const min = parseInt(input.min);
        const max = parseInt(input.max);
        validateInput(input, min, max);
      });
    });
    
    // 初始化 - 设置倒计时初始目标时间
    setTargetTime();
    updateTimeDisplay();
    updateLapsList();
  </script>
</body>
</html>
